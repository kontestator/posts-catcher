<!doctype html>
<html lang="ru">
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>VK Post Receiver</title>
<script src="https://unpkg.com/@vkontakte/vk-bridge/dist/browser.min.js"></script>
<style>
  body { font: 16px/1.5 system-ui, sans-serif; max-width: 760px; margin: 32px auto; }
  button { padding: 10px 14px; border-radius: 10px; border: 1px solid #ddd; cursor: pointer; }
  pre { white-space: pre-wrap; background: #fafafa; border: 1px solid #eee; padding: 12px; border-radius: 12px; }
</style>

<h1>VK Post Receiver</h1>
<p>–ü–æ–ª—É—á–∞–µ–º —Ç–æ–∫–µ–Ω ‚Üí —á–∏—Ç–∞–µ–º 17 –ø–æ—Å—Ç–æ–≤ ‚Üí —à–ª—ë–º –ö–ê–ñ–î–´–ô –ø–æ—Å—Ç –≤ Make.</p>

<div style="display:flex; gap:8px; flex-wrap:wrap; margin: 16px 0;">
  <button id="btnToken">1 ) –ó–∞–ø—Ä–æ—Å–∏—Ç—å —Ç–æ–∫–µ–Ω</button>
  <button id="btnFetch" disabled>2) –ü–æ–ª—É—á–∏—Ç—å 17 –ø–æ—Å—Ç–æ–≤</button>
  <button id="btnSend" disabled>3) –û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤—Å–µ –≤ Make</button>
</div>

<pre id="log">init‚Ä¶</pre>

<script>
  // === –ó–ê–ú–ï–ù–ò –ù–ê –°–í–û–Å ===
  const APP_ID   = 51420719; // –¢–≤–æ–π ID –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
  const GROUP_ID = 216031511; // ID —Ç–≤–æ–µ–π –≥—Ä—É–ø–ø—ã
  // !!! –í–°–¢–ê–í–¨ –°–Æ–î–ê –°–í–û–ô WEBHOOK –ò–ó MAKE !!!
  const MAKE_WEBHOOK = "https://hook.us2.make.com/gto4rg5hbigjl0juv2a1244ld50ves97";

  const log = (...a ) => document.getElementById('log').textContent =
    a.map(x => typeof x === 'string' ? x : JSON.stringify(x, null, 2)).join('\n');

  let ACCESS_TOKEN = null;
  let lastResponse = null;

  (async () => {
    try {
      await vkBridge.send('VKWebAppInit');
      log('Bridge init: ok. –ù–∞–∂–º–∏ "–ó–∞–ø—Ä–æ—Å–∏—Ç—å —Ç–æ–∫–µ–Ω".');
    } catch (e) {
      log('–û—à–∏–±–∫–∞ VKWebAppInit', e?.error_data || e?.message || e);
    }
  })();

  // --- –®–ê–ì 1: –ó–∞–ø—Ä–æ—Å —Ç–æ–∫–µ–Ω–∞ ---
  document.getElementById('btnToken').onclick = async () => {
    try {
      const { access_token } = await vkBridge.send('VKWebAppGetAuthToken', {
        app_id: APP_ID,
        scope: 'wall,groups'
      });
      ACCESS_TOKEN = access_token;
      document.getElementById('btnFetch').disabled = !ACCESS_TOKEN;
      log('–¢–æ–∫–µ–Ω –ø–æ–ª—É—á–µ–Ω ‚úÖ', { access_token: ACCESS_TOKEN.slice(0, 25) + '‚Ä¶' });
    } catch (e) {
      log('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Ç–æ–∫–µ–Ω ‚ùå', e?.error_data || e?.message || e);
    }
  };

  // --- –®–ê–ì 2: –ß—Ç–µ–Ω–∏–µ 17 –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –ø–æ—Å—Ç–æ–≤ ---
  document.getElementById('btnFetch').onclick = async () => {
    if (!ACCESS_TOKEN) return;
    log('–ó–∞–ø—Ä–∞—à–∏–≤–∞—é 17 –ø–æ—Å—Ç–æ–≤...');
    try {
      const { response } = await vkBridge.send('VKWebAppCallAPIMethod', {
        method: 'wall.get',
        params: {
          owner_id: -Math.abs(GROUP_ID),
          count: 17,
          v: '5.199',
          access_token: ACCESS_TOKEN
        }
      });
      lastResponse = response;
      document.getElementById('btnSend').disabled = !lastResponse || !lastResponse.items.length;
      log(`–ü–æ–ª—É—á–µ–Ω–æ ${response.items.length} –ø–æ—Å—Ç–æ–≤ ‚úÖ`, response);
    } catch (e) {
      log('–û—à–∏–±–∫–∞ wall.get ‚ùå', e?.error_data || e?.message || e);
    }
  };

  // --- –®–ê–ì 3: –û—Ç–ø—Ä–∞–≤–∫–∞ –ö–ê–ñ–î–û–ì–û –ø–æ—Å—Ç–∞ –≤ Make ---
  document.getElementById('btnSend').onclick = async () => {
    if (!lastResponse || !MAKE_WEBHOOK) return log('Webhook –Ω–µ —É–∫–∞–∑–∞–Ω –∏–ª–∏ –ø–æ—Å—Ç—ã –Ω–µ –ø–æ–ª—É—á–µ–Ω—ã.');
    
    const posts = lastResponse.items || [];
    if (posts.length === 0) return log('–ù–µ—Ç –ø–æ—Å—Ç–æ–≤ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏.');

    log(`–ù–∞—á–∏–Ω–∞—é –æ—Ç–ø—Ä–∞–≤–∫—É ${posts.length} –ø–æ—Å—Ç–æ–≤ –≤ Make...`);

    for (const item of posts) {
      try {
        const payload = {
          event: "wall_post_new",
          group_id: GROUP_ID,
          post_id: item.id,
          date_unix: item.date,
          text: item.text || '',
          attachments: item.attachments || [],
          from_id: item.from_id,
          owner_id: item.owner_id,
          source_url: `https://vk.com/wall-${GROUP_ID}_${item.id}`,
          received_at: new Date( ).toISOString()
        };

        await fetch(MAKE_WEBHOOK, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        log(`–ü–æ—Å—Ç #${item.id} —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤ Make ‚úÖ`);
        // –ò–ó–ú–ï–ù–ï–ù–û: –ü–∞—É–∑–∞ —É–≤–µ–ª–∏—á–µ–Ω–∞ –¥–æ 2 —Å–µ–∫—É–Ω–¥ –¥–ª—è —Å—Ç–∞–±–∏–ª—å–Ω–æ–π —Ä–∞–±–æ—Ç—ã
        await new Promise(resolve => setTimeout(resolve, 5000));

      } catch (e) {
        log(`–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø–æ—Å—Ç–∞ #${item.id} ‚ùå`, e?.message || e);
      }
    }

    log('–í—Å–µ –ø–æ—Å—Ç—ã –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã! üéâ');
  };
</script>
</html>
